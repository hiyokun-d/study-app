generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

// datasource db {
//   provider = "postgresql"
// url      = env("DATABASE_URL")
// }

datasource db {
  provider = "postgresql"
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model bookings {
  id                                     String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  student_id                             String          @db.Uuid
  tutor_id                               String          @db.Uuid
  tutor_offer_id                         String?         @db.Uuid
  start_at                               DateTime        @db.Timestamptz(6)
  end_at                                 DateTime        @db.Timestamptz(6)
  duration_minutes                       Int
  price                                  Decimal         @db.Decimal(10, 2)
  status                                 booking_status? @default(pending)
  created_at                             DateTime?       @default(now()) @db.Timestamptz(6)
  updated_at                             DateTime?       @default(now()) @db.Timestamptz(6)
  profiles_bookings_student_idToprofiles profiles        @relation("bookings_student_idToprofiles", fields: [student_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_bookings_tutor_idToprofiles   profiles        @relation("bookings_tutor_idToprofiles", fields: [tutor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  tutor_offers                           tutor_offers?   @relation(fields: [tutor_offer_id], references: [id], onUpdate: NoAction)
  messages                               messages[]
  reviews                                reviews[]
  transactions                           transactions[]

  @@index([start_at], map: "idx_bookings_start_at")
  @@index([student_id], map: "idx_bookings_student")
  @@index([tutor_id], map: "idx_bookings_tutor")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model messages {
  id                                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  from_id                             String    @db.Uuid
  to_id                               String    @db.Uuid
  booking_id                          String?   @db.Uuid
  content                             String
  metadata                            Json?     @default("{}")
  created_at                          DateTime? @default(now()) @db.Timestamptz(6)
  is_read                             Boolean?  @default(false)
  bookings                            bookings? @relation(fields: [booking_id], references: [id], onUpdate: NoAction)
  profiles_messages_from_idToprofiles profiles  @relation("messages_from_idToprofiles", fields: [from_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_messages_to_idToprofiles   profiles  @relation("messages_to_idToprofiles", fields: [to_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([from_id, to_id, created_at(sort: Desc)], map: "idx_messages_conversation")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model notifications {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profile_id String    @db.Uuid
  type       String
  payload    Json?
  seen       Boolean?  @default(false)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  profiles   profiles  @relation(fields: [profile_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([profile_id], map: "idx_notifications_profile")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model profiles {
  id                                     String                 @id @default(dbgenerated("auth.uid()")) @db.Uuid
  full_name                              String?
  display_name                           String?
  avatar_url                             String?
  bio                                    String?
  is_tutor                               Boolean?               @default(false)
  hourly_rate                            Decimal?               @db.Decimal(10, 2)
  subjects                               String[]
  created_at                             DateTime?              @default(now()) @db.Timestamptz(6)
  updated_at                             DateTime?              @default(now()) @db.Timestamptz(6)
  bookings_bookings_student_idToprofiles bookings[]             @relation("bookings_student_idToprofiles")
  bookings_bookings_tutor_idToprofiles   bookings[]             @relation("bookings_tutor_idToprofiles")
  messages_messages_from_idToprofiles    messages[]             @relation("messages_from_idToprofiles")
  messages_messages_to_idToprofiles      messages[]             @relation("messages_to_idToprofiles")
  notifications                          notifications[]
  reviews_reviews_reviewee_idToprofiles  reviews[]              @relation("reviews_reviewee_idToprofiles")
  reviews_reviews_reviewer_idToprofiles  reviews[]              @relation("reviews_reviewer_idToprofiles")
  transactions                           transactions[]
  tutor_availabilities                   tutor_availabilities[]
  tutor_offers                           tutor_offers[]

  @@index([is_tutor], map: "idx_profiles_is_tutor")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model reviews {
  id                                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  booking_id                             String?   @db.Uuid
  reviewer_id                            String    @db.Uuid
  reviewee_id                            String    @db.Uuid
  rating                                 Int
  comment                                String?
  created_at                             DateTime? @default(now()) @db.Timestamptz(6)
  bookings                               bookings? @relation(fields: [booking_id], references: [id], onUpdate: NoAction)
  profiles_reviews_reviewee_idToprofiles profiles  @relation("reviews_reviewee_idToprofiles", fields: [reviewee_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  profiles_reviews_reviewer_idToprofiles profiles  @relation("reviews_reviewer_idToprofiles", fields: [reviewer_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([reviewee_id], map: "idx_reviews_reviewee")
}

model subjects {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug        String    @unique
  name        String
  description String?
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model transactions {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profile_id       String           @db.Uuid
  booking_id       String?          @db.Uuid
  amount           Decimal          @db.Decimal(12, 2)
  currency         String?          @default("USD") @db.VarChar(8)
  kind             transaction_kind
  provider_payload Json?
  status           String           @default("pending")
  created_at       DateTime?        @default(now()) @db.Timestamptz(6)
  bookings         bookings?        @relation(fields: [booking_id], references: [id], onUpdate: NoAction)
  profiles         profiles         @relation(fields: [profile_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([profile_id], map: "idx_transactions_profile")
}

model tutor_availabilities {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tutor_id       String    @db.Uuid
  available_from DateTime  @db.Timestamptz(6)
  available_to   DateTime  @db.Timestamptz(6)
  timezone       String?
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  profiles       profiles  @relation(fields: [tutor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([tutor_id], map: "idx_tutor_availabilities_tutor")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model tutor_offers {
  id               String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  tutor_id         String     @db.Uuid
  title            String
  summary          String?
  about            String?
  price_per_hour   Decimal    @db.Decimal(10, 2)
  duration_minutes Int        @default(60)
  subject_ids      String[]   @default([]) @db.Uuid
  is_active        Boolean?   @default(true)
  created_at       DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime?  @default(now()) @db.Timestamptz(6)
  bookings         bookings[]
  profiles         profiles   @relation(fields: [tutor_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([is_active], map: "idx_tutor_offers_active")
  @@index([tutor_id], map: "idx_tutor_offers_tutor")
}

enum booking_status {
  pending
  confirmed
  cancelled
  completed
  failed
}

enum transaction_kind {
  booking_payment
  payout
  refund
  adjustment
}
